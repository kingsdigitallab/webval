<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <link rel="shortcut icon" href="#">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>KDL Accessibility</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/
font-awesome/5.15.2/css/all.min.css"/>
    <script type="module">
      import { updateGithubJsonFile, readGithubJsonFile } from "./utils.js";
      window.updateGithubJsonFile = updateGithubJsonFile
      window.readGithubJsonFile = readGithubJsonFile
    </script>    
    <script src="https://unpkg.com/vue@3"></script>
    <script type="module">
      import { Octokit } from "https://cdn.skypack.dev/@octokit/core";
      window.Octokit = Octokit
    </script>    
  </head>
  <body>
    <section class="section" id="app">
      <div class="container">
        <h1 class="title is-1">
          KDL Accessibility
        </h1>
        <div class="control">
          <label class="label">Project:</label> 
          <div class="select">
            <select @change="onChangeProject()" v-model="selection.project">
              <option v-for="project in projects" :value="project.slug">{{ project.name }}</option>
            </select>
          </div>
        </div>

        <h2 class="title is-2">Issues</h2>
        <div class="field is-grouped">
          <div class="control">
            <button @click="onClickEvaluate()" name="action" value="evaluate" class="button is-primary" :disabled="isReadOnly">
              <template v-if="isEvaluating">Evaluating...</template><template v-else>Evaluate</template>
            </button>
          </div>
          <div class="control">
            <button @click="onClickSave()" name="action" value="save" class="button is-primary" :disabled="isReadOnly">Save</button>
          </div>
        </div>
        <table class="table is-striped is-hoverable">
          <thead>
            <tr>
              <td>Webpath</td>
              <td>Level</td>
              <td>Principle</td>
              <td>Guideline</td>
              <td>Rule</td>
              <td>Target</td>
              <td>Roles</td>
              <td>Complexity</td>
              <td>Fixed</td>
              <td>Comment</td>
            </tr>
          </thead>
          <tbody>
            <tr v-for="(issue, idx) in issues">
              <td><a :href="issue.host + issue.webpath">{{ issue.webpath }}</a></td>
              <td>{{ issue.code }} {{ issue.rule.level }}</td>
              <td>{{ getPrincipleFromIssue(issue) }}</td>
              <td>{{ issue.rule.guideline }}</td>
              <td>{{ issue.rule.rule }}</td>
              <td>{{ issue.rule.target }}</td>
              <td><select v-model="issue.roles" :disabled="isReadOnly">
                <option v-for="(roleName, roleIdx) in roles" :value="roleName">{{roleName}}</option>
              </select></td>
              <td><select v-model="issue.complexity" :disabled="isReadOnly">
                <option v-for="(compName, compIdx) in complexities" :value="compName">{{compName}}</option>
              </select></td>
              <td>
                <label class="checkbox">
                  <input type="checkbox" v-model="issue.fixed" :disabled="isReadOnly" />
                  Fixed
                </label>
              </td>
              <td><input type="text" v-model="issue.comment" :disabled="isReadOnly" /></td>
            </tr>
          </tbody>
        </table>

        <form :class="{field: 1, notification: 1, 'is-warning': isReadOnly}">
          <div class="field">
            <label class="label">Personal access token:</label>
            <input type="password" v-model="selection.gtoken" class="input">
            <a href="https://docs.github.com/en/authentication/keeping-your-account-and-data-secure/creating-a-personal-access-token" target="_blank">Please generate and provide a github Personal Access Token to interact with the page</a>
          </div>
        </form>
      </div>
    </section>
    <script>
      window.addEventListener("load", function(event) {
        const { createApp } = Vue

        createApp({
          data() {
            return {
              projects: [],
              issues: [],
              selection: {
                project: null,
                gtoken: null
              }
            }
          },
          async mounted() {
            // TODO: non-blocking
            let res = await readGithubJsonFile('projects/projects.json')
            this.projects = res.data
            this.projects_sha = res.sha
            this.loadSelection()
          },
          watch: {
            selection: {
              deep: true,
              handler(val, valOld) {
                this.saveSelection()
              }
            }
          },
          computed: {
            project() {
              let ret = this.projects.filter(p => p.slug == this.selection.project)
              return ret ? ret[0] : null
            },
            isReadOnly() {
              return this.isEvaluating || !this.selection.gtoken
            },
            complexities() {
              return ['XS', 'S', 'M', 'L', 'XL']
            },
            roles() {
              return ['U', 'D', 'UD', 'A', 'P']
            },
            isEvaluating() {
              let ret = (this.project?.a11y?.evaluationStart || '0') > (this.project?.a11y?.evaluationEnd || '0')
              console.log(ret)
              return ret
            }
          },
          methods: {
            loadSelection() {
              this.selection = JSON.parse(window.localStorage.getItem('a11y.selection'))
              if (!this.selection?.project) {
                this.selection = {project: null}
              }
              this.onChangeProject()
            },
            saveSelection() {
              window.localStorage.setItem('a11y.selection', JSON.stringify(this.selection))
            },
            async onChangeProject() {
              // load issues
              let res = await readGithubJsonFile(`projects/${this.selection.project}/a11y-issues.json`)
              if (res) {
                this.issues = res.data.issues
                this.issues_sha = res.sha
              } else {
                this.issues = []
                this.issues_sha = null
              }
            },
            getPrincipleFromIssue(issue) {
              return "Perceivable Operable Understandable Robust".split(" ")[issue.rule.principle-1]
            },
            getGuidelineFromIssue(issue) {
              const principlesGuidelines = [
                [],
                [],
                [],
                [],
              ]
              return principlesGuidelines[issue.rule.principle-1][issue.rule.guideline-1]
            },
            getOctokit(){
              let ret = null
              if (this.selection.gtoken) {
                ret = new Octokit({
                  auth: this.selection.gtoken
                })
              }
              return ret
            },
            async onClickSave() {
              if (this.isReadOnly) return;
              
              await updateGithubJsonFile(`projects/${this.selection.project}/a11y-issues.json`, {issues: this.issues}, this.getOctokit())
            },
            async onClickEvaluate() {
              if (this.isReadOnly) return;
              
              this.project.a11y.evaluationStart = new Date().toISOString()

              await updateGithubJsonFile(`projects/projects.json`, this.projects, this.getOctokit())
              await updateGithubJsonFile(`projects/evaluate.json`, {slug: this.selection.project, requested: new Date().toISOString()}, this.getOctokit())
            }
          }
        }).mount('#app');
      })
    </script>
  </body>
</html>
