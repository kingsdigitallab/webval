<!DOCTYPE html>
<html> 
  <head>
    <meta charset="utf-8">
    <link rel="shortcut icon" href="#">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>KDL Accessibility</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/
font-awesome/5.15.2/css/all.min.css"/>
    <script type="module">
      import { updateGithubJsonFile, readGithubJsonFile } from "./utils.js";
      window.updateGithubJsonFile = updateGithubJsonFile
      window.readGithubJsonFile = readGithubJsonFile
    </script>    
    <script src="https://unpkg.com/vue@3"></script>
    <script type="module">
      import { Octokit } from "https://cdn.skypack.dev/@octokit/core";
      window.Octokit = Octokit
    </script>    
    <style>
      .code-block {
        display: inline-block;
        padding: 0.5em;
        font-size: 80%;
        font-family: monospace;
        background-color: black;
        color: lightgreen;
      }
    </style>
  </head>
  <body>
    <section class="section" id="app">
      <div class="container">
        <h1 class="title is-1">
          KDL Accessibility
        </h1>
        <div class="control">
          <label class="label">Project:</label> 
          <div class="select">
            <select @change="onChangeProject()" v-model="selection.project">
              <option v-for="project in projects" :value="project.slug">{{ project.name }}</option>
            </select>
          </div>
        </div>
        <p v-if="project">
          Last evaluation: {{ formatDate(project.a11y.evaluationEnd) }}
        </p>

        <h2 class="title is-2">Issues ({{ issuesFiltered.length }})</h2>
        <div class="field is-grouped">
          <div class="control">
            <button @click="onClickEvaluate()" name="action" value="evaluate" class="button is-primary" :disabled="isReadOnly">
              <template v-if="isEvaluating">Evaluating...</template><template v-else>Evaluate</template>
            </button>
          </div>
          <div class="control">
            <button @click="onClickSave()" name="action" value="save" class="button is-primary" :disabled="isReadOnly">Save</button>
          </div>
          <div class="control">
            <select v-model="selection.levels">
              <option v-for="levels in levelsOptions" :value="levels.key">{{ levels.title }}</option>
            </select>
          </div>
        </div>
        <table class="table is-striped is-hoverable">
          <thead>
            <tr>
              <td>Location</td>
              <td>Level</td>
              <td>Category</td>
              <td>Rule</td>
              <td>Roles</td>
              <td>Complexity</td>
              <td>Fixed</td>
              <td>Comment</td>
            </tr>
          </thead>
          <tbody>
            <tr v-for="(issue, idx) in issuesFiltered" :class="['issue-level-'+getLevelFromIssue(issue)]">
              <td :title="issue.context">
                <a :href="'//' + issue.host + issue.webpath" target="_blank">{{ issue.webpath }}</a>
                <br>
                {{ issue.selector }}
                <br>
                <span class="code-block">
                  {{ issue.context }}
                </span>
              </td>
              <td><span :class="['tag', getTagClassFromIssue(issue)]">{{ getLevelFromIssue(issue) }}</span></td>
              <td>{{ getPrincipleFromIssue(issue) }} 
                <br>
                &gt; {{ getGuidelineFromIssue(issue) }}
              </td>
              <td><a :href="'https://www.w3.org/WAI/WCAG21/Understanding/'+getIdFromIssue(issue)+'.html'" target="_blank">
                {{ getNumbersFromIssue(issue) }} {{ getRuleFromIssue(issue) }}
              </a></td>
              <td><select v-model="issue.roles" :disabled="isReadOnly">
                <option v-for="(roleName, roleIdx) in roles" :value="roleName">{{roleName}}</option>
              </select></td>
              <td><select v-model="issue.complexity" :disabled="isReadOnly">
                <option v-for="(compName, compIdx) in complexities" :value="compName">{{compName}}</option>
              </select></td>
              <td>
                <label class="checkbox">
                  <input type="checkbox" v-model="issue.fixed" :disabled="isReadOnly" />
                  Fixed
                </label>
              </td>
              <td><input type="text" v-model="issue.comment" :disabled="isReadOnly" /></td>
            </tr>
          </tbody>
        </table>

        <form :class="{field: 1, notification: 1, 'is-warning': isReadOnly}">
          <div class="field">
            <label class="label">Personal access token:</label>
            <input type="password" v-model="selection.gtoken" class="input">
            <a href="https://docs.github.com/en/authentication/keeping-your-account-and-data-secure/creating-a-personal-access-token" target="_blank">Please generate and provide a github Personal Access Token to interact with the page</a>
          </div>
        </form>
      </div>
    </section>
    <script>
      window.addEventListener("load", function(event) {
        const { createApp } = Vue

        createApp({
          data() {
            return {
              projects: [],
              issues: [],
              selection: {
                // see getDefaultSelection()
              }
            }
          },
          async mounted() {
            // TODO: non-blocking
            this.rules = (await readGithubJsonFile('projects/rules.json')).data
            this.loadSelection()
            this.loadProjects()
            this.onChangeProject()

            setInterval(this.checkEvaluation, 60000);
          },
          watch: {
            selection: {
              deep: true,
              handler(val, valOld) {
                this.saveSelection()
              }
            }
          },
          computed: {
            project() {
              let ret = this.projects.filter(p => p.slug == this.selection.project)
              return ret ? ret[0] : null
            },
            isReadOnly() {
              return this.isEvaluating || !this.selection.gtoken
            },
            complexities() {
              return ['XS', 'S', 'M', 'L', 'XL']
            },
            roles() {
              return ['U', 'D', 'UD', 'A', 'P']
            },
            isEvaluating() {
              let ret = (this.project?.a11y?.evaluationStart || '0') > (this.project?.a11y?.evaluationEnd || '0')
              return ret
            },
            issuesFiltered() {
              return this.issues.filter(issue => {
                ret = true
                if (this.selection.levels && !this.selection.levels.includes('|'+this.getLevelFromIssue(issue)+'|')) {
                  ret = false
                }
                return ret
              })
            },
            levelsOptions() {
              return [
                {title: 'All', key: ''},
                {title: 'A', key: '|A|'},
                {title: 'AA', key: '|AA|'},
                {title: 'A + AA', key: '|A|AA|'},
                {title: 'AAA', key: '|AAA|'},
              ]
            }
          },
          methods: {
            async loadProjects() {
              let res = await readGithubJsonFile('projects/projects.json', this.getOctokit())
              this.projects = res.data
              this.projects_sha = res.sha
            },
            loadSelection() {
              this.selection = JSON.parse(window.localStorage.getItem('a11y.selection'))
              if (!this.selection?.project) {
                this.selection = this.getDefaultSelection()
              }
            },
            getDefaultSelection() {
              return {
                project: null,
                levels: '',
                gtoken: null
              }
            },
            saveSelection() {
              window.localStorage.setItem('a11y.selection', JSON.stringify(this.selection))
            },
            async onChangeProject() {
              // load issues
              let res = await readGithubJsonFile(`projects/${this.selection.project}/a11y-issues.json`, this.getOctokit())
              if (res) {
                this.issues = res.data.issues
                this.issues_sha = res.sha
              } else {
                this.issues = []
                this.issues_sha = null
              }
            },
            // getPrincipleFromIssue(issue) {
            //   return "Perceivable Operable Understandable Robust".split(" ")[issue.rule.principle-1]
            // },
            getLevelFromIssue(issue) {
              return this.rules.rules[this.getNumbersFromIssue(issue)].level
            },
            getPrincipleFromIssue(issue) {
              return this.rules.principles[issue.rule.principle].title
            },
            getGuidelineFromIssue(issue) {
              let r = issue.rule
              return this.rules.guidelines[`${r.principle}.${r.guideline}`].title
            },
            getRuleFromIssue(issue) {
              return this.rules.rules[this.getNumbersFromIssue(issue)].title
            },
            getNumbersFromIssue(issue) {
              return `${issue.rule.principle}.${issue.rule.guideline}.${issue.rule.rule}`
            },
            getTagClassFromIssue(issue) {
              return {
                'A': 'is-danger',
                'AA': 'is-warning',
                'AAA': 'is-info',
              }[this.getLevelFromIssue(issue)]
            },
            getOctokit(){
              let ret = null
              if (this.selection.gtoken) {
                ret = new Octokit({
                  auth: this.selection.gtoken
                })
              }
              return ret
            },
            getIdFromIssue(issue){
              return this.rules.rules[this.getNumbersFromIssue(issue)].id
            },
            async onClickSave() {
              if (this.isReadOnly) return;
              
              await updateGithubJsonFile(`projects/${this.selection.project}/a11y-issues.json`, {issues: this.issues}, this.getOctokit())
            },
            async onClickEvaluate() {
              if (this.isReadOnly) return;
              
              this.project.a11y.evaluationStart = new Date().toISOString()

              await updateGithubJsonFile(`projects/projects.json`, this.projects, this.getOctokit())
              await updateGithubJsonFile(`projects/evaluate.json`, {slug: this.selection.project, requested: new Date().toISOString()}, this.getOctokit())
            },
            formatDate(adate) {
              if (!adate?.toDateString) {
                adate = new Date(adate)
              }
              let ret = adate.toLocaleTimeString()
              if ((new Date()).toLocaleDateString() != adate.toLocaleDateString()) {
                ret = `${adate.toLocaleDateString()} ${ret}` 
              }
              return ret;
            },
            checkEvaluation() {
              if (this.isEvaluating) {
                this.loadProjects()
                if (!this.isEvaluating) {
                  this.onChangeProject()
                }
              }
            }
          }
        }).mount('#app');
      })
    </script>
  </body>
</html>
