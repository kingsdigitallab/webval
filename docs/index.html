<!DOCTYPE html>
<html> 
  <head>
    <meta charset="utf-8">
    <link rel="shortcut icon" href="#">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>KDL Accessibility</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css"/>
    <script type="module">
      import { updateGithubJsonFile, readGithubJsonFile } from "./utils.js";
      window.updateGithubJsonFile = updateGithubJsonFile
      window.readGithubJsonFile = readGithubJsonFile
    </script>    
    <script src="https://unpkg.com/vue@3"></script>
    <script type="module">
      import { Octokit } from "https://cdn.skypack.dev/@octokit/core";
      window.Octokit = Octokit
    </script>    
    <style>
      .code-block {
        display: inline-block;
        padding: 0.5em;
        font-size: 80%;
        font-family: monospace;
        background-color: black;
        color: lightgreen;
      }
      .issue-comment {
        min-width: 10em;
        min-height: 4em;
      }
    </style>
  </head>
  <body>
    <section class="section" id="app">
      <div class="container">
        <h1 class="title is-1">
          KDL Accessibility
        </h1>
        <div class="control">
          <label class="label">Project:</label> 
          <div class="select">
            <select @change="onChangeProject()" v-model="selection.project">
              <option v-for="project in projects" :value="project.slug">{{ project.name }}</option>
            </select>
          </div>
        </div>
        <p v-if="project">
          Last evaluation: {{ formatDate(project.a11y.evaluationStarted) }}
        </p>

        <h2 class="title is-2">Issues ({{ issuesFiltered.length }})</h2>
        <div class="field is-grouped">
          <div class="control">
            <button @click="onClickEvaluate()" name="action" value="evaluate" class="button is-primary" :disabled="isReadOnly">
              <template v-if="isEvaluating">Evaluating...</template><template v-else>Evaluate</template>
            </button>
          </div>
          <div class="control">
            <button @click="onClickSave()" name="action" value="save" class="button is-primary" :disabled="isReadOnly">Save</button>
          </div>
          <div class="select">
            <select v-model="selection.levels">
              <option v-for="levels in levelsOptions" :value="levels.key">{{ levels.title }}</option>
            </select>
          </div>
          &nbsp;
          <div class="select">
            <select v-model="selection.resolutions">
              <option v-for="resolutions in resolutionsOptions" :value="resolutions.key">{{ resolutions.title }}</option>
            </select>
          </div>
        </div>
        <table class="table is-striped is-hoverable">
          <thead>
            <tr>
              <td>Location</td>
              <td>Level</td>
              <td>Category</td>
              <td>Rule</td>
              <td>Roles</td>
              <td>Complexity</td>
              <td>Resolution</td>
              <td>Comment</td>
            </tr>
          </thead>
          <tbody>
            <tr v-for="(issue, idx) in issuesFiltered" :class="['issue-level-'+getLevelFromIssue(issue)]">
              <td>
                <a :href="'//' + issue.host + issue.webpath" target="_blank">{{ issue.webpath }}</a>
                <br>
                {{ issue.selector }}
                <br>
                <span class="code-block">
                  {{ issue.context }}
                </span>
              </td>
              <td><span :class="['tag', getTagClassFromIssue(issue)]">{{ getLevelFromIssue(issue) }}</span></td>
              <td>{{ getPrincipleFromIssue(issue) }} 
                <br>
                &gt; {{ getGuidelineFromIssue(issue) }}
              </td>
              <td :title="issue.message"><a :href="'https://www.w3.org/WAI/WCAG21/Understanding/'+getIdFromIssue(issue)+'.html'" target="_blank">
                {{ getNumbersFromIssue(issue) }} {{ getRuleFromIssue(issue) }}
              </a></td>
              <td><div class="select">
                <select v-model="evaluation.annotations[issue.hash].roles" :disabled="isReadOnly">
                  <option v-for="(roleName, roleIdx) in roles" :value="roleName">{{roleName}}</option>
                </select>
              </div></td>
              <td><div class="select">
                <select v-model="evaluation.annotations[issue.hash].complexity" :disabled="isReadOnly">
                  <option v-for="(compName, compIdx) in complexities" :value="compName">{{compName}}</option>
                </select>
              </div></td>
              <td>
                <div class="select">
                  <select v-model="evaluation.annotations[issue.hash].resolution" :disabled="isReadOnly">
                    <option v-for="(name, idx) in resolutions" :value="name">{{name}}</option>
                  </select>
                </div>
              </td>
              <td>
                <input class="input issue-comment" type="text" v-model="evaluation.annotations[issue.hash].comment" :disabled="isReadOnly" />
              </td>
            </tr>
          </tbody>
        </table>

        <form @submit.stop.prevent="onAddNewIssue" v-if="project" class="box">
          <div class="field is-grouped">
            <label>Web path</label>
            <div class="control">
              <div class="select">
                <select v-model="newIssue.webpath" :disabled="isReadOnly">
                  <option v-for="url in project.a11y.urls" :value="url">{{url}}</option>
                </select>
              </div>
            </div>
            &nbsp;
            <label>WCAG Rule</label>
            <div class="select">
              <select v-model="newIssue.ruleNumber" :disabled="isReadOnly">
                <template v-for="rule in this.rules.rules"><option :value="rule.code" v-if="this.isLevelSelected(rule.level)">{{ rule.code }} {{ rule.title }} ({{ rule.level }})</option></template>
              </select>
            </div>
            &nbsp;
            <div class="control">
              <button type="submit" name="action" value="addIssue" :disabled="isReadOnly" class="button is-primary">Add new issue</button>
            </div>
          </div>
          <div class="field is-grouped">
            <label>Context (HTML element)
              <input type="text" class="input" v-model="newIssue.context">
            </label>
            &nbsp;
            <label>Selector
              <input type="text" class="input" v-model="newIssue.selector">
            </label>
            &nbsp;
            <label>Problem
              <input type="text" class="input" v-model="newIssue.message">
            </label>
          </div>
        </form>

        <form :class="{notification: 1, 'is-warning': isReadOnly}">
          <div class="field">
            <label class="label">Personal access token:</label>
            <input type="password" v-model="selection.gtoken" class="input">
            <a href="https://docs.github.com/en/authentication/keeping-your-account-and-data-secure/creating-a-personal-access-token" target="_blank">Please generate and provide a github Personal Access Token to interact with the page</a>
          </div>
        </form>
      </div>
    </section>
    <script>
      window.addEventListener("load", function(event) {
        const { createApp } = Vue

        // TODO: move to utils and share with evaluate.js
        function getKeyFromIssue(issue, includeWebPath=false) {
          let ret = `${issue.code}|${issue.context}|${issue.selector}`
          if (includeWebPath) {
            ret = `${issue.webpath}|` + ret
          }
          ret = hashCode(ret)
          return ret
        }

        // TODO: move to utils and share with evaluate.js
        /**
         * Returns a hash code from a string
         * @param  {String} str The string to hash.
         * @return {Number}    A 32bit integer
         * @see http://werxltd.com/wp/2010/05/13/javascript-implementation-of-javas-string-hashcode-method/
         * @see https://stackoverflow.com/a/8831937
         */
        function hashCode(str) {
          let hash = 0;
          for (let i = 0, len = str.length; i < len; i++) {
              let chr = str.charCodeAt(i);
              hash = (hash << 5) - hash + chr;
              hash |= 0; // Convert to 32bit integer
          }
          return hash;
        }


        createApp({
          data() {
            return {
              projects: [],
              evaluation: {
                issues: {},
                annotations: {}
              },
              // issues: {},
              // annotations: {},
              selection: {
                // see getDefaultSelection()
              },
              newIssue: {
                webpath: '',
                ruleNumber: '',
                context: '',
                message: '',
                selecgtor: ''
              }
            }
          },
          async mounted() {
            // TODO: non-blocking
            this.rules = (await readGithubJsonFile('projects/rules.json')).data
            this.loadSelection()
            this.loadProjects()
            this.onChangeProject()

            setInterval(this.checkEvaluation, 60000);
          },
          watch: {
            selection: {
              deep: true,
              handler(val, valOld) {
                this.saveSelection()
              }
            }
          },
          computed: {
            issues() {
              return this.evaluation.issues
            },
            annotations() {
              return this.evaluation.annotations
            },
            project() {
              let ret = this.projects.filter(p => p.slug == this.selection.project)
              return ret ? ret[0] : null
            },
            isReadOnly() {
              return this.isEvaluating || !this.selection.gtoken
            },
            complexities() {
              return ['XS', 'S', 'M', 'L', 'XL']
            },
            resolutions() {
              return ['Todo', 'In progress', 'Addressed', 'Won\'t']
            },
            roles() {
              return ['U', 'D', 'UD', 'A', 'P']
            },
            isEvaluating() {
              let ret = (this.project?.a11y?.evaluationRequested || '0') > (this.project?.a11y?.evaluationEnded || '0')
              return ret
            },
            issuesFiltered() {
              let ret = Object.values(this.issues).filter(issue => {
                // filter by selected levels
                if (!this.isLevelSelected(this.getLevelFromIssue(issue))) {
                  return false
                }
                // issues detected in the last evaluation OR issues manually entered
                if (issue.detected && issue.detected != this.evaluation.meta.evaluationStarted) {
                  return false
                }
                // addressed or won't issues
                if (this.selection.resolutions != 'all') {                  
                  let isClosed = 'Addressed|Won\'t'.includes(this.annotations[issue.hash].resolution)
                  if (isClosed == (this.selection.resolutions == 'open')) {
                    return false
                  }
                }
                return true
              })
              
              // sort by (page, level, code)
              let getSortKey = (issue) => {
                return (''+issue.webpath.length).padStart(3,'0')
                  + (this.getLevelFromIssue(issue).padStart(3, '0'))
                  + (issue.rule.principle)
                  + (issue.rule.guideline.padStart(2,'0'))
                  + (issue.rule.rule.padStart(3,'0'))
              }

              ret = ret.sort((a, b) => {
                return getSortKey(a) > getSortKey(b)
              })
              
              return ret
            },
            levelsOptions() {
              return [
                {title: 'All levels', key: ''},
                {title: 'A', key: '|A|'},
                {title: 'AA', key: '|AA|'},
                {title: 'A + AA', key: '|A|AA|'},
                {title: 'AAA', key: '|AAA|'},
              ]
            },
            resolutionsOptions() {
              return [
                {title: 'Open issues', key: 'open'},
                {title: 'All issues', key: 'all'},
                {title: 'Closed issues', key: 'closed'},
              ]
            }
          },
          methods: {
            async loadProjects() {
              let res = await readGithubJsonFile('projects/projects.json', this.getOctokit())
              this.projects = res.data
              this.projects_sha = res.sha
            },
            loadSelection() {
              this.selection = JSON.parse(window.localStorage.getItem('a11y.selection'))
              if (!this.selection?.project) {
                this.selection = this.getDefaultSelection()
              }
            },
            getDefaultSelection() {
              return {
                project: null,
                levels: '',
                resolutions: '',
                gtoken: null
              }
            },
            saveSelection() {
              window.localStorage.setItem('a11y.selection', JSON.stringify(this.selection))
            },
            async onChangeProject() {
              // load issues
              let res = await readGithubJsonFile(`projects/${this.selection.project}/a11y-issues.json`, this.getOctokit())
              if (res) {
                this.evaluation = res.data
                this.evaluation_sha = res.sha
              } else {
                this.evaluation = {
                  issues: {},
                  annotations: {}
                }
                this.evaluation_sha = null
              }
            },
            // getPrincipleFromIssue(issue) {
            //   return "Perceivable Operable Understandable Robust".split(" ")[issue.rule.principle-1]
            // },
            isLevelSelected(level) {
              return !(this.selection.levels && !this.selection.levels.includes('|'+level+'|'))
            },
            getLevelFromIssue(issue) {
              return this.rules.rules[this.getNumbersFromIssue(issue)].level
            },
            getPrincipleFromIssue(issue) {
              return this.rules.principles[issue.rule.principle].title
            },
            getGuidelineFromIssue(issue) {
              let r = issue.rule
              return this.rules.guidelines[`${r.principle}.${r.guideline}`].title
            },
            getRuleFromIssue(issue) {
              return this.rules.rules[this.getNumbersFromIssue(issue)].title
            },
            getDescriptionFromIssue(issue) {
              return this.rules.rules[this.getNumbersFromIssue(issue)].description
            },
            getNumbersFromIssue(issue) {
              return `${issue.rule.principle}.${issue.rule.guideline}.${issue.rule.rule}`
            },
            getTagClassFromIssue(issue) {
              return {
                'A': 'is-danger',
                'AA': 'is-warning',
                'AAA': 'is-info',
              }[this.getLevelFromIssue(issue)]
            },
            getOctokit(){
              let ret = null
              if (this.selection.gtoken) {
                ret = new Octokit({
                  auth: this.selection.gtoken
                })
              }
              return ret
            },
            getIdFromIssue(issue){
              return this.rules.rules[this.getNumbersFromIssue(issue)].id
            },
            async onClickSave() {
              if (this.isReadOnly) return;
              
              this.evaluation_sha = await updateGithubJsonFile(`projects/${this.selection.project}/a11y-issues.json`, this.evaluation, this.getOctokit(), this.evaluation_sha)
            },
            async onClickEvaluate() {
              if (this.isReadOnly) return;
              
              this.project.a11y.evaluationRequested = new Date().toISOString()

              this.projects_sha = await updateGithubJsonFile(`projects/projects.json`, this.projects, this.getOctokit())
              await updateGithubJsonFile(`projects/evaluate.json`, {slug: this.selection.project, requested: this.project.a11y.evaluationRequested}, this.getOctokit(), this.projects_sha)
            },
            formatDate(adate) {
              if (!adate?.toDateString) {
                adate = new Date(adate)
              }
              let ret = adate.toLocaleTimeString()
              if ((new Date()).toLocaleDateString() != adate.toLocaleDateString()) {
                ret = `${adate.toLocaleDateString()} ${ret}` 
              }
              return ret;
            },
            checkEvaluation() {
              if (this.isEvaluating) {
                this.loadProjects()
                if (!this.isEvaluating) {
                  this.onChangeProject()
                }
              }
            },
            onAddNewIssue() {
              let newIssue = this.newIssue
              let codeParts = newIssue.ruleNumber.split('.')
              let rule = this.rules[newIssue.ruleNumber]
              let issue = {
                code: `MANUAL-ISSUE-${newIssue.ruleNumber}`,
                message: newIssue.message,
                context: newIssue.context,
                selector: newIssue.selector,
                runner: "manual",
                host: this.project.sites.liv,
                webpath: newIssue.webpath,
                rule: {
                  standard: 'WCAG2',
                  principle: codeParts[0],
                  guideline: codeParts[1],
                  rule: codeParts[2],
                }
              }
              issue.hash = getKeyFromIssue(issue, true)
              console.log(issue)
              if (!this.issues[issue.hash]) { 
                this.issues[issue.hash] = issue

                this.annotations[issue.hash] = {
                }
              }
            }
          }
        }).mount('#app');
      })
    </script>
  </body>
</html>
